# Plan V1 Schema Documentation

## Overview

The `plan.v1.json` schema defines execution plans generated by LLM services for document modification. This schema contains only whitelisted atomic operations that can be safely executed through Word COM automation.

## Schema Version

- **Version**: `plan.v1`
- **Purpose**: LLM-generated execution plan with atomic operations
- **File Extension**: `.json`

## Root Object

```json
{
  "schema_version": "plan.v1",
  "ops": [ ... ]
}
```

## Field Definitions

### schema_version (required)
- **Type**: `string`
- **Value**: `"plan.v1"`
- **Description**: Schema version identifier

### ops (required)
Array of atomic operations to be executed in sequence.

## Whitelisted Atomic Operations

### 1. delete_section_by_heading

Deletes a document section from a heading to the next same-level heading.

```json
{
  "op": "delete_section_by_heading",
  "heading_text": "摘要",
  "level": 1,
  "match": "EXACT",
  "case_sensitive": false,
  "occurrence_index": null
}
```

**Parameters:**
- `heading_text` (string, required): Text to match in heading
- `level` (integer, required): Heading level (1-9)
- `match` (string, required): Match mode - `"EXACT"`, `"CONTAINS"`, `"REGEX"`
- `case_sensitive` (boolean, optional): Case-sensitive matching, default `false`
- `occurrence_index` (integer, optional): Which occurrence to match (0-based), default `null` (first)

### 2. update_toc

Updates all Table of Contents fields in the document.

```json
{
  "op": "update_toc"
}
```

**Parameters:** None

### 3. delete_toc

Deletes Table of Contents from the document.

```json
{
  "op": "delete_toc",
  "mode": "ALL"
}
```

**Parameters:**
- `mode` (string, required): Deletion mode - `"ALL"`, `"FIRST"`, `"LAST"`

### 4. set_style_rule

Modifies style object properties.

```json
{
  "op": "set_style_rule",
  "target_style": "Heading 1",
  "font_east_asian": "楷体",
  "font_latin": "Times New Roman",
  "font_size_pt": 12,
  "font_bold": true,
  "line_spacing_mode": "MULTIPLE",
  "line_spacing_value": 2.0
}
```

**Parameters:**
- `target_style` (string, required): Style name to modify
- `font_east_asian` (string, optional): East Asian font name
- `font_latin` (string, optional): Latin font name
- `font_size_pt` (integer, optional): Font size in points
- `font_bold` (boolean, optional): Bold formatting
- `line_spacing_mode` (string, optional): `"SINGLE"`, `"MULTIPLE"`, `"EXACTLY"`
- `line_spacing_value` (number, optional): Spacing value

### 5. reassign_paragraphs_to_style

Reassigns paragraphs matching criteria to a target style.

```json
{
  "op": "reassign_paragraphs_to_style",
  "selector": {
    "current_style": "Normal",
    "contains_text": "Figure",
    "paragraph_indexes": [5, 10, 15]
  },
  "target_style": "Caption",
  "clear_direct_formatting": true
}
```

**Parameters:**
- `selector` (object, required): Selection criteria
  - `current_style` (string, optional): Current style name
  - `contains_text` (string, optional): Text content filter
  - `paragraph_indexes` (array, optional): Specific paragraph indexes
- `target_style` (string, required): Target style name
- `clear_direct_formatting` (boolean, optional): Clear direct formatting, default `false`

### 6. clear_direct_formatting

Clears direct formatting from specified range.

```json
{
  "op": "clear_direct_formatting",
  "scope": "SELECTION",
  "range_spec": {
    "start_paragraph": 0,
    "end_paragraph": 10
  },
  "authorization": "EXPLICIT_USER_CONSENT"
}
```

**Parameters:**
- `scope` (string, required): `"DOCUMENT"`, `"SELECTION"`, `"RANGE"`
- `range_spec` (object, optional): Range specification for `"RANGE"` scope
  - `start_paragraph` (integer): Starting paragraph index
  - `end_paragraph` (integer): Ending paragraph index
- `authorization` (string, required): Must be `"EXPLICIT_USER_CONSENT"`

## Operation Sequencing

Operations are executed in the order they appear in the `ops` array. Consider dependencies:

1. **Structure modifications first**: `delete_section_by_heading`, `delete_toc`
2. **Style modifications**: `set_style_rule`, `reassign_paragraphs_to_style`
3. **Formatting cleanup**: `clear_direct_formatting`
4. **TOC updates last**: `update_toc`

## Example Plans

### Basic Document Cleanup
```json
{
  "schema_version": "plan.v1",
  "ops": [
    {
      "op": "delete_section_by_heading",
      "heading_text": "摘要",
      "level": 1,
      "match": "EXACT",
      "case_sensitive": false
    },
    {
      "op": "delete_section_by_heading",
      "heading_text": "参考文献",
      "level": 1,
      "match": "EXACT",
      "case_sensitive": false
    },
    {
      "op": "update_toc"
    }
  ]
}
```

### Style Standardization
```json
{
  "schema_version": "plan.v1",
  "ops": [
    {
      "op": "set_style_rule",
      "target_style": "Heading 1",
      "font_east_asian": "楷体",
      "font_size_pt": 12,
      "font_bold": true,
      "line_spacing_mode": "MULTIPLE",
      "line_spacing_value": 2.0
    },
    {
      "op": "reassign_paragraphs_to_style",
      "selector": {
        "current_style": "Normal",
        "contains_text": "图"
      },
      "target_style": "Caption",
      "clear_direct_formatting": true
    }
  ]
}
```

## Validation Rules

1. **schema_version** must be exactly `"plan.v1"`
2. **ops** must be non-empty array
3. Each operation must have valid `op` field matching whitelist
4. All required parameters must be present for each operation
5. Parameter values must match expected types and constraints
6. No unknown fields allowed in operations

## Security Constraints

### Whitelist Enforcement
Only the 6 operations listed above are allowed. Any other operation will cause plan rejection.

### Parameter Validation
- String parameters are sanitized and length-limited
- Integer parameters have range validation
- Boolean parameters accept only `true`/`false`
- Enum parameters accept only predefined values

### Authorization Requirements
- `clear_direct_formatting` requires explicit authorization
- No direct text content manipulation allowed
- All modifications through Word object layer only

## Error Handling

Invalid plan.v1.json files will be rejected with `INVALID_PLAN` status:

- Unknown operation types
- Missing required parameters
- Invalid parameter values
- Security constraint violations
- Malformed JSON structure

## LLM Integration Guidelines

### For LLM Services
1. Generate only valid JSON matching this schema
2. Use only whitelisted operations
3. Include all required parameters
4. Validate parameter types and values
5. Consider operation sequencing dependencies

### Schema Gateway
The schema acts as a security gateway:
- Validates all LLM output before execution
- Rejects non-compliant plans immediately
- Prevents unauthorized operations
- Ensures parameter safety

## Related Schemas

- `structure.v1.json`: Input document structure for planning
- `inventory.full.v1.json`: Complete document inventory for reference